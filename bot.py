from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ConversationHandler, CallbackContext
import requests
import os

# Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
ASK_NAME, ASK_PHONE, CHAT = range(3)  # âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø±ÙŠÙ CHAT Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… CallMeBot)
WHATSAPP_NUMBER = os.getenv("WHATSAPP_NUMBER")  # Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
CALLMEBOT_API_KEY = os.getenv("CALLMEBOT_API_KEY")  # API Key Ù…Ù† CallMeBot

# Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨
def send_whatsapp_message(name, phone):
    message = f"ğŸ“¢ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯ Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {name}\nğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: {phone}"
    url = f"https://api.callmebot.com/whatsapp.php?phone={WHATSAPP_NUMBER}&text={message}&apikey={CALLMEBOT_API_KEY}"
    requests.get(url)

# Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
async def start(update: Update, context: CallbackContext) -> int:
    await update.message.reply_text("Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ù†Ø§ Ø±Ø§Ù†ÙŠØ©ØŒ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ø¹ÙŠØ§Ø¯Ø© Ø¯. Ø®Ø§Ù„Ø¯ Ø­Ø³ÙˆÙ†. Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.")
    return ASK_NAME

# Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³Ù…
async def ask_name(update: Update, context: CallbackContext) -> int:
    context.user_data['name'] = update.message.text
    await update.message.reply_text("Ø´ÙƒØ±Ù‹Ø§! Ø§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ.")
    return ASK_PHONE

# Ø·Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
async def ask_phone(update: Update, context: CallbackContext) -> int:
    phone = update.message.text
    if not phone.isdigit():  # âœ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¯Ø®Ù„ ÙŠØ­ØªÙˆÙŠ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù…
        await update.message.reply_text("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­.")
        return ASK_PHONE

    context.user_data['phone'] = phone
    name = context.user_data['name']

    # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨
    send_whatsapp_message(name, phone)

    await update.message.reply_text(f"Ø´ÙƒØ±Ù‹Ø§ {name}! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø·Ø±Ø­ Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙƒ.")
    return CHAT  # âœ… Ø§Ù„Ø¢Ù† CHAT Ù…Ø¹Ø±Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­

# Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async def chat(update: Update, context: CallbackContext) -> int:
    await update.message.reply_text("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ!")
    return ConversationHandler.END

# Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
async def cancel(update: Update, context: CallbackContext) -> int:
    await update.message.reply_text("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ Ø¨Ø¥Ø±Ø³Ø§Ù„ /start")
    return ConversationHandler.END

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙˆØª
def main():
    app = Application.builder().token(os.getenv("TELEGRAM_BOT_TOKEN")).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            ASK_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_name)],
            ASK_PHONE: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_phone)],
            CHAT: [MessageHandler(filters.TEXT & ~filters.COMMAND, chat)],  # âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† CHAT Ù…Ø¹Ø±Ù
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    app.add_handler(conv_handler)

    print("Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†...")
    app.run_polling()

if __name__ == "__main__":
    main()
    
